# L2-LACP

LACP, Link Aggregation Control Protocol, 链路汇聚控制协议。是一种实现链路动态汇聚与解汇聚的协议。

LACP 协议通过LACPDU（Link Aggregation Control Protocol Data Unit，链路汇聚控制协议数据单元）与对端交互信息。

LACPDU帧为慢协议（平均每秒发送的协议报文不超过5个），如果接口板收到报文的DMAC是特殊的组播地址0x01-80-c2-00-00-02，二层协议类型字段为0x8809，协议子类型为0x01，则说明此数据报文为LACPDU帧。

随着网络规模不断扩大，用户对骨干链路的带宽和可靠性提出了越来越高的要求。在传统技术中，常用更换高速率的接口板或更换支持高速率接口板的设备的方式来增加带宽，但这种方案需要付出高额的费用，而且不够灵活。采用链路聚合技术（LACP）可以在不进行硬件升级的条件下，通过将多个物理接口捆绑为一个逻辑接口，来达到增加链路带宽的目的。在实现增大带宽目的的同时，链路聚合采用备份链路的机制，可以有效的提高设备之间链路的可靠性。



----

### 链路聚合原理

链路聚合是**把两台设备之间的多条物理链路聚合在一起，当做一条逻辑链路来使用**。这两台设备可以是一对路由器，一对交换机，或者是一台路由器和一台交换机。一条聚合链路可以包含多条成员链路；链路聚合能够提高链路带宽。理论上，通过聚合几条链路，一个聚合口的带宽可以扩展为所有成员口带宽的总和，这样就有效地增加了逻辑链路的带宽。

链路聚合为网络提供了高可靠性。配置了链路聚合之后，如果一个成员接口发生故障，该成员口的物理链路会把流量切换到另一条成员链路上。

链路聚合还可以在一个聚合口上实现**负载均衡**，一个聚合口可以把流量分散到多个不同的成员口上，通过成员链路把流量发送到同一个目的地，将网络产生拥塞的可能性降到最低。

|         |        | Eth-Trunk1 |        |         |
| ------- | ------ | ---------- | ------ | ------- |
|         | G0/0/1 | ←→         | G0/0/1 |         |
| SwitchA | G0/0/2 | ←→         | G0/0/2 | SwitchB |
|         | G0/0/3 | ←→         | G0/0/3 |         |



----

### 链路聚合模式

链路聚合包含两种模式：

- 手动负载均衡模式
- LACP（Link Aggregation Control Protocol）模式



#### 手工负载分担模式

Eth-Trunk的建立、成员接口的加入由手工配置，**没有链路聚合控制协议的参与。该模式下所有活动链路都参与数据的转发，平均分担流量，因此称为负载分担模式**。如果某条活动链路故障，链路聚合组自动*在剩余的活动链路中平均分担流量*。当需要在两个直连设备间提供一个较大的链路带宽而设备又不支持LACP协议时，可以使用手工负载分担模式。



#### LACP模式

LACP模式又分为：

- 静态LACP模式
- 动态LACP模式

**静态LACP模式**和**动态LACP模式**在LACP协议交互方面没有区别，链路两端的设备相互发送LACP报文，协商聚合参数。协商完成后，两台设备确定活动接口和非活动接口。需要手动创建一个Eth-Trunk口，并添加成员口。LACP协商选举活动接口和非活动接口。LACP模式也叫M:N模式。M代表**活动成员链路**，用于在**负载均衡**模式中转发数据。N代表**非活动成员链路**，用于**冗余备份**。如果一条活动链路发生故障，该链路传输的数据被切换到一条优先级最高的备份链路上，这条*备份链路转变为活动状态*。

**静态LACP模式**和**动态LACP模式**区别在于：两种模式在LACP协商失败后的处理不一致

- 静态LACP模式下，LACP协商失败后Eth-Trunk变为Down，不能转发数据。

- 动态LACP模式下，LACP协商失败后Eth-Trunk变为Down，但其成员接口继承Eth-Trunk的VLAN属性状态变为Indep，可独立进行二层数据转发。















----

> - [Reference Doc 1](https://support.huawei.com/enterprise/zh/doc/EDOC1100174722/daca9171)
> - [Reference Doc 2](https://zhuanlan.zhihu.com/p/19033070064)

