# L2-VLAN

VLAN（Virtual Local Area Network，虚拟局域网）是一种在逻辑上将一个物理局域网划分为多个广播域的技术。

VLAN是一种技术手段而非协议，但是依赖于协议来实现。实际是依赖于 IEEE 802.1Q 协议（即 VLAN tagging 协议）。

VLAN技术把用户划分成多组逻辑的网络，**组内可以通信，组间不允许通信**。二层转发的单播、组播、广播报文只能在组内转发。


> 相关协议：
> - IEEE 802.1Q：定义了VLAN的实现标准，规定了VLAN数据帧的格式。
> - LNP（链路类型协商协议）：用于动态协商以太网接口的链路类型为Access或Trunk。
> - QinQ：通过在802.1Q标签报文的基础上再增加一层802.1Q的Tag来扩展VLAN空间，实现私网VLAN透传公网。

为了实现转发控制，在待转发的以太网帧中添加 VLAN标签 ，然后设定交换机端口对该标签和帧的处理方式：
- 丢弃帧
- 转发帧
- 添加标签
- 移除标签



### 帧格式

IEEE 802.1Q 封装的VLAN数据帧格式如下:

| **字段**         | **传统以太网帧（字节数）** | **VLAN 帧（字节数）**                                        |
| ---------------- | -------------------------- | ------------------------------------------------------------ |
| 目的 MAC 地址    | 6                          | 6                                                            |
| 源 MAC 地址      | 6                          | 6                                                            |
| VLAN 标签        | -                          | 4<br />新增字段，按顺序细分如下：<br />TPID（2 byte）<br />PRI（3 bit）<br />CFI（1 bit）<br />VID（12 bit） |
| Length/Type      | 2                          | 2                                                            |
| Data（数据载荷） | 46 - 1500                  | 42 - 1500（因 VLAN 标签占用 4 字节，数据载荷减少 4 字节）    |
| FCS（帧校验）    | 4                          | 4                                                            |

- **TPID**：Tag Protocol ID，标签协议标识。固定取值为0x8100，表明这是一个携带 802.1Q 标签的帧。

- **PRI**：Priority，优先级。指示帧的优先级，0-7，表示8种优先级，提供有差别的转发服务。

- **CFI**：Canonical Format Indicator，标准格式指示。在以太网环境中，这个字段始终为0。

- **VID**：VLAN ID。标识了该数据帧所属的VLAN，数据帧只能在其所属VLAN内进行传输。

  - VLAN ID取值范围是0~4095（0 ~ 2^12-1）。

  - 由于0和4095为协议保留取值，所以VLAN ID的有效取值范围是*1~4094*。

802.1Q帧是由交换机来处理的，而不是用户主机来处理的：

- 交换机内部处理的数据帧都带有VLAN标签。而交换机连接的部分设备（如用户主机、服务器）只会收发不带VLAN tag的传统以太网数据帧。因此，要与这些设备交互，就需要交换机的接口能够识别传统以太网数据帧，并在收发时给帧添加、剥除VLAN标签。添加什么VLAN标签，由接口上的缺省VLAN（Port Default VLAN ID，PVID）决定。

- 当交换机收到普通的以太网帧时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称“打标签”。

- 当交换机转发802.1Q帧时，可能会删除其4字节VLAN标记转变为普通以太网帧，简称“去标签”。



----

### 划分方式

- 基于端口（常用）
- 基于MAC
- 基于协议
- 基于子网
- 基于策略（安全）



----

### 链路区分

交换网络中存在了 带VLAN 的以太网帧和 不带VLAN 的以太网帧。因此，相应地也对链路做了区分：

- 接入链路（Access Link）：连接*用户设备和交换机*的链路。通过的帧为 **不带VLAN Tag** 的以太网帧。用户设备通常不识别 VLAN Tag，因此在数据帧通过时，VLAN Tag会被剥离或添加。

- 干道链路（Trunk Link）：连接*交换机和交换机*的链路。通过的帧一般为 **带VLAN Tag** 以太网帧，也允许通过 **不带VLAN Tag** 的以太网帧。



----

### 接口类型及处理机制

VLAN的接口类型，也即**端口类型**。

现网中属于同一个VLAN的用户可能会被连接在不同的交换机上，且跨越交换机的VLAN可能不止一个，如果需要用户间的互通，就需要交换机间的接口能够同时识别和发送多个VLAN的数据帧。根据接口连接对象以及对收发数据帧处理的不同，当前有VLAN的多种接口类型，以适应不同的连接和组网。

不同厂商对VLAN接口类型的定义可能不同。对于华为设备来说，常见的VLAN接口类型有三种，包括：Access、Trunk和Hybrid。


**端口的缺省VLAN ID**

- 在思科交换机上称为Native VLAN，即本地VLAN。
- 在华为交换机上称为Port VLAN ID，即端口VLAN ID，简记为PVID。每个端口有且只有一个PVID，默认情况下端口的PVID都为1（即端口属于VLAN 1），所有端口互通。


#### Access接口

Access接口，即接入端口，一般用于和**不能识别VLAN Tag的用户终端**（如用户主机、服务器）相连，或者不需要区分不同VLAN成员时使用。

在一个VLAN交换网络中，以太网数据帧主要有以下两种形式：

- 无标记帧（Untagged帧）：原始的、未加入4字节VLAN标签的帧。
- 有标记帧（Tagged帧）：加入了4字节VLAN标签的帧。


处理方式：

- 接入端口只能属于一个VLAN，只能为Untagged帧添加*唯一VLAN的Tag*

- 接入端口的PVID值与端口所属VLAN的ID相同（默认为1）

- 接入端口接收处理方法：一般只接收"未打标签"的普通以太网MAC帧。根据接收帧的端口PVID值给帧"打标签"，即插入4字节的VLAN标记字段，字段中的VID取值与端口PVID取值相等。

- 接入端口发送处理方法：若帧中的VID与端口的PVID相等，则"去标签"并转发该帧；否则不转发。



#### Trunk接口

Trunk接口，即干道端口，一般用于**连接交换机、路由器、AP以及可同时收发Tagged帧和Untagged帧的终端**。

- 干道端口可以属于多个VLAN。允许多个VLAN的帧带Tag通过，即使VID不为PVID。

- 用户可以设置干道端口的PVID值，默认情况下，干道端口PVID值为1。

- 干道端口发送处理方法：

  - 对VID等于PVID的帧，“去标签，再转发”。

  - 对VID不等于PVID的帧，直接转发。

- 干道端口接收处理方法：

  - 接收"未打标签"的帧。根据接收帧的端口的PVID给帧"打标签"，即插入4字节的VLAN标记字段，字段中的VID取值与端口的PVID取值相等。

  - 若VID在端口允许通过的VLAN列表中，则直接接收"已打标签的帧"，否则丢弃。



#### Hybrid接口

Hybrid为非通用接口，华为交换机有，其他不确定。

- 混合端口（Hybrid Port）：既可以用于交换机之间或交换机与路由器之间的互连（同Trunk端口），也可用于交换机与用户计算机之间的互连（同Access端口）。

- 混合端口可以属于多个VLAN（同Trunk端口）。

- 用户可以设置混合端口的PVID值。默认情况下，混合端口的PVID值为1（同Trunk端口）。

- 混合端口发送处理方法（与Trunk端口不同）：

  - 查看帧的VID是否在端口的"去标签"列表中。该列表可配置。

  - 若存在（untag），则"去标签"后转发。

  - 若不存在（tag），则直接转发。

- 混合端口接收处理方法（同Trunk端口）：

  - 接收"未打标签"的帧。根据接收帧的端口的PVID给帧"打标签"，即插入4字节的VLAN标记字段，字段中的VID取值与端口的PVID取值相等。

  - 若VID在端口允许通过的VLAN列表中，则直接接收"已打标签的帧"，否则丢弃。



----

### VLAN内通信

即总结VLAN接口/端口类型及标签处理机制：

| 端口类型   | 接收帧（入站）                       | 帧处理和转发                                                 | 发送帧（出站）                           | 典型应用场景                         |
| :--------- | :----------------------------------- | ------------------------------------------------------------ | :--------------------------------------- | :----------------------------------- |
| **Access** | **无条件打上PVID**                   | 查找VID对应的MAC表：<br />- 若出站端口为入站端口，丢弃<br />- 若出站端口查找成功且非入站端口，发送到出站端口<br />- 若查找失败，VLAN内部泛洪，VLAN的所有非入站端口均发送该帧 | **无条件剥离标签**                       | 连接终端用户设备                     |
| **Trunk**  | 检查标签，有标且允许则收，无标打PVID | 查找VID对应的MAC表：<br />- 若出站端口为入站端口，丢弃<br />- 若出站端口查找成功且非入站端口，发送到出站端口<br />- 若查找失败，VLAN内部泛洪，VLAN的所有非入站端口均发送该帧 | **VLAN == PVID ? 剥标 : 带标**           | 交换机互联，传输多VLAN流量           |
| **Hybrid** | 检查标签，有标且允许则收，无标打PVID | 查找VID对应的MAC表：<br />- 若出站端口为入站端口，丢弃<br />- 若出站端口查找成功且非入站端口，发送到出站端口<br />- 若查找失败，VLAN内部泛洪，VLAN的所有非入站端口均发送该帧 | **按配置决定：VLAN by VLAN地剥标或带标** | 灵活场景（如连接AP、IP电话、服务器） |



----

### VLAN间通信

VLAN隔离了二层广播域，也就严格地隔离了各个VLAN之间的任何流量，分属于**不同VLAN的用户不能互相通信**。

不同VLAN 之间的流量不能直接跨越VLAN的边界，需要使用路由，通过路由将报文从一个VLAN 转发到另外一个VLAN。

解决办法：
- 传统路由器 + 单臂路由（Router-on-a-Stick）​：多个VLAN共用一条物理连接到路由器。
  - 适用场景​​：小型网络，成本敏感。
- 三层交换机
  - ​​适用场景​​：中大型网络，高性能需求。


#### 路由器单臂路由

路由器虽为三层设备，但其接口具有​​二层能力​​（如生成 MAC 地址、收发以太网帧）。

路由器在物理接口上创建多个子接口是网络技术中实现逻辑隔离与复用物理链路的重要手段，尤其在 VLAN（虚拟局域网）环境中应用广泛。操作方法：

- 交换机​​：配置对端为路由器的端口为 Trunk 端口（如 switchport mode trunk），允许多个 VLAN 通过。

- ​​路由器​​：在物理接口上创建多个子接口（Sub-interface），每个子接口对应一个VLAN，并配置 IP 地址作为该 VLAN 的网关。




#### 三层交换机

三层交换机 = 二层交换 + 三层路由（通过 ​Switch Virtual Interface，​SVI 交换机虚拟接口​​ 实现）。

**SVI接口的特点**：

- **虚拟性**：并非物理端口，而是基于 VLAN 创建的逻辑接口，与 VLAN 一一对应（一个 VLAN 可对应一个 SVI）。
- **三层属性**：需配置 IP 地址和子网掩码，支持三层路由协议（如 OSPF、RIP）。
- **依赖VLAN状态**：SVI 接口的 “up” 状态需满足两个条件：
  - 交换机上该 VLAN 已创建且存在活跃的物理端口（或 trunk 端口承载该 VLAN）。
  - 接口本身已启用（`no shutdown`）。

**SVI接口的核心作用**

- **VLAN间路由**
  
  二层交换机只能在同一 VLAN 内转发数据，而三层交换机通过 SVI 接口为每个 VLAN 分配 IP 地址，使不同 VLAN 的设备能通过 SVI 进行跨网段通信（类似路由器的子网间转发功能）。
  
  例如：VLAN 10 的设备默认网关设为 SVI 10 的 IP，VLAN 20 的设备默认网关设为 SVI 20 的 IP，两者可通过三层交换机的 SVI 接口互访。

- **交换机管理**

  管理员可通过 SVI 接口的 IP 地址远程登录交换机（如 SSH、Telnet），进行配置和监控。通常会为默认 VLAN（如 VLAN 1）配置 SVI 作为管理接口。


**路由过程**：

三层交换机的路由过程是结合了二层交换与三层路由的高效转发机制，其核心是通过**硬件ASIC芯片**实现快速路由（而非传统路由器的软件转发），同时利用SVI（交换机虚拟接口）和路由表完成不同VLAN/子网间的数据转发。以下是其详细路由过程：


-  一、路由前提：基础配置与路由表生成
   1. **VLAN与SVI配置**  
      三层交换机需为每个需跨网段通信的VLAN创建SVI接口，并配置IP地址（作为该VLAN的网关）。例如：  
      - VLAN 10的SVI接口IP：192.168.10.1/24  
      - VLAN 20的SVI接口IP：192.168.20.1/24  

   2. **路由表生成**  
      三层交换机会自动将SVI接口的直连网段（如192.168.10.0/24、192.168.20.0/24）加入路由表。若需与其他网络（如外部路由器、互联网）通信，需配置静态路由或动态路由协议（如OSPF、RIP），生成非直连网段的路由条目。


- 二、数据转发过程（以VLAN 10到VLAN 20为例）
  假设场景：  

  - 源设备：PC1（VLAN 10，IP：192.168.10.10，网关：192.168.10.1）  
  - 目标设备：PC2（VLAN 20，IP：192.168.20.10，网关：192.168.20.1）  

  

  - 步骤1：源设备封装数据帧
    PC1判断目标IP（192.168.20.10）与自身不在同一网段，因此将数据发送到默认网关（即VLAN 10的SVI接口192.168.10.1）。  
    - 数据帧结构：  
      - 源MAC：PC1的MAC地址  
      - 目标MAC：三层交换机VLAN 10的SVI接口MAC（通过ARP协议获取）  
      - 封装的IP包：源IP=192.168.10.10，目标IP=192.168.20.10  
  - 步骤2：三层交换机接收并解析数据帧
    1. 三层交换机的物理端口（属于VLAN 10）接收数据帧，通过二层交换芯片检查VLAN标签，确认属于VLAN 10。  
    2. 由于目标MAC是SVI 10的MAC，数据帧被转发至三层路由引擎处理（而非二层转发）。  
  - 步骤3：三层路由决策
    - 路由引擎提取IP包的目标IP（192.168.20.10），查询路由表，匹配到直连网段192.168.20.0/24，对应的出接口为SVI 20（192.168.20.1）。  
    - 此时，三层交换机会**剥离原数据帧的源MAC和目标MAC**（即解封装），准备重新封装。  
  - 步骤4：重新封装数据帧并转发
    1. 三层交换机通过ARP协议查询目标IP（192.168.20.10）对应的MAC地址（PC2的MAC）。  
    2. 生成新的数据帧：  
       - 源MAC：三层交换机VLAN 20的SVI接口MAC  
       - 目标MAC：PC2的MAC地址  
       - IP包保持不变（源IP和目标IP未修改） 
    3. 二层交换芯片根据目标MAC和VLAN 20的端口信息，将数据帧从属于VLAN 20的物理端口转发出去。  
  - 步骤5：目标设备接收数据
    PC2接收数据帧，检查目标MAC匹配自身，解封装后获取IP包，完成通信。  


- 三、关键技术：CEF（Cisco Express Forwarding）
  三层交换机的高效路由依赖**CEF技术**，其核心是通过硬件ASIC芯片预先构建两个表：  


  - **转发信息库（FIB）**：路由表的硬件镜像，存储IP前缀与出接口的映射，实现快速路由查找。  
  - **邻接表**：存储IP地址与MAC地址的映射（类似ARP缓存），避免每次转发时的ARP查询延迟。  

  通过CEF，三层交换机可在**硬件层面**完成路由查找和数据转发，转发速率接近二层交换，远高于传统路由器的软件转发。

- 四、总结
  三层交换机的路由过程可概括为：  

  1. 接收二层数据帧，判断需三层处理（目标MAC为SVI接口MAC）；  
  2. 解封装并根据目标IP查询路由表，确定出接口；  
  3. 重新封装数据帧（更新源/目标MAC），通过二层交换转发至目标网段。  



----

### 相关协议

#### IEEE 802.1Q

IEEE 802.1Q（也被称为Dot1q）即Virtual Bridged Local Area Networks协议（虚拟桥接局域网），规定了VLAN的实现标准。与标准的以太网数据帧相比，VLAN数据帧增加了1个4字节的VLAN标签。


#### LNP

链路类型协商协议（Link-type Negotiation Protocol，LNP）用来动态协商以太网接口的链路类型为Access或者Trunk。

以太网接口的链路类型协商为Access，缺省情况下加入VLAN1。

以太网接口的链路类型协商为Trunk，缺省情况下加入VLAN1～4094。


#### QinQ

QinQ（802.1Q-in-802.1Q）协议出自IEEE 802.1ad标准协议，通过在802.1Q标签报文的基础上再增加一层802.1Q的Tag来达到扩展VLAN空间的功能，可以使私网VLAN透传公网。

由于在骨干网中传递的报文有*两层802.1Q Tag*（一层公网Tag，一层私网Tag），即802.1Q-in-802.1Q，所以称之为QinQ协议。






----

> - [Reference Doc 1](https://blog.csdn.net/HinsCoder/article/details/130454920)
