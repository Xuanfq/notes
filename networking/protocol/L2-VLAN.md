# L2-VLAN

VLAN（Virtual Local Area Network，虚拟局域网）是一种在逻辑上将一个物理局域网划分为多个广播域的技术。

VLAN是一种技术手段而非协议，但是依赖于协议来实现。实际是依赖于 IEEE 802.1Q 协议（即 VLAN tagging 协议）。

VLAN技术把用户划分成多组逻辑的网络，**组内可以通信，组间不允许通信**。二层转发的单播、组播、广播报文只能在组内转发。


> 相关协议：
> - IEEE 802.1Q：定义了VLAN的实现标准，规定了VLAN数据帧的格式。
> - LNP（链路类型协商协议）：用于动态协商以太网接口的链路类型为Access或Trunk。
> - QinQ：通过在802.1Q标签报文的基础上再增加一层802.1Q的Tag来扩展VLAN空间，实现私网VLAN透传公网。

为了实现转发控制，在待转发的以太网帧中添加 VLAN标签 ，然后设定交换机端口对该标签和帧的处理方式：
- 丢弃帧
- 转发帧
- 添加标签
- 移除标签



### 帧格式

IEEE 802.1Q 封装的VLAN数据帧格式如下:

| **字段**         | **传统以太网帧（字节数）** | **VLAN 帧（字节数）**                                        |
| ---------------- | -------------------------- | ------------------------------------------------------------ |
| 目的 MAC 地址    | 6                          | 6                                                            |
| 源 MAC 地址      | 6                          | 6                                                            |
| VLAN 标签        | -                          | 4<br />新增字段，按顺序细分如下：<br />TPID（2 byte）<br />PRI（3 bit）<br />CFI（1 bit）<br />VID（12 bit） |
| Length/Type      | 2                          | 2                                                            |
| Data（数据载荷） | 46 - 1500                  | 42 - 1500（因 VLAN 标签占用 4 字节，数据载荷减少 4 字节）    |
| FCS（帧校验）    | 4                          | 4                                                            |

- **TPID**：Tag Protocol ID，标签协议标识。固定取值为0x8100，表明这是一个携带 802.1Q 标签的帧。

- **PRI**：Priority，优先级。指示帧的优先级，0-7，表示8种优先级，提供有差别的转发服务。

- **CFI**：Canonical Format Indicator，标准格式指示。在以太网环境中，这个字段始终为0。

- **VID**：VLAN ID。标识了该数据帧所属的VLAN，数据帧只能在其所属VLAN内进行传输。

  - VLAN ID取值范围是0~4095（0 ~ 2^12-1）。

  - 由于0和4095为协议保留取值，所以VLAN ID的有效取值范围是*1~4094*。

802.1Q帧是由交换机来处理的，而不是用户主机来处理的：

- 交换机内部处理的数据帧都带有VLAN标签。而交换机连接的部分设备（如用户主机、服务器）只会收发不带VLAN tag的传统以太网数据帧。因此，要与这些设备交互，就需要交换机的接口能够识别传统以太网数据帧，并在收发时给帧添加、剥除VLAN标签。添加什么VLAN标签，由接口上的缺省VLAN（Port Default VLAN ID，PVID）决定。

- 当交换机收到普通的以太网帧时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称“打标签”。

- 当交换机转发802.1Q帧时，可能会删除其4字节VLAN标记转变为普通以太网帧，简称“去标签”。





























----

> - [Reference Doc 1](https://blog.csdn.net/HinsCoder/article/details/130454920)
