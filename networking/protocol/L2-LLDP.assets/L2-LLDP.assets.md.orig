# L2-LLDP

LLDP, Link Layer Discovery Protocol 是IEEE 802.1ab中定义的链路层发现协议。

LLDP是一种标准的二层发现方式，可以将本端设备的管理地址、设备标识、接口标识等信息组织起来，并发布给自己的邻居设备，邻居设备收到这些信息后将其以标准的管理信息库MIB（Management Information Base）的形式保存起来，以供网络管理系统NMS（Network Management System，网络管理系统）查询及判断链路的通信状况。

LLDP提供了一种标准的链路层发现方式。通过LLDP获取的设备二层信息能够快速获取相连设备的拓扑状态；显示出客户端、交换机、路由器、应用服务器以及网络服务器之间的路径；检测设备间的配置冲突、查询网络失败的原因。企业网用户可以通过使用网管系统，对支持运行LLDP协议的设备进行链路状态监控，在网络发生故障的时候快速进行故障定位。



----

## 应用场景

### 单邻居组网

单邻居组网应用场景是指交换机设备的接口之间或者交换机与媒体终端ME（Media Endpoint）的接口之间是直接相连，中间没有跨任何的设备，而且接口只有一个邻居设备的情况。单邻居组网如下图所示，SwitchA和SwitchB之间以及SwitchA和ME之间均是直接相连，SwitchA和SwitchB的每一个接口都只有一个邻居。

![单邻居组网应用场景](https://download.huawei.com/mdl/image/download?uuid=ea44990f96a14b70ae41f207da0cfbfd)



### 多邻居组网

多邻居组网应用场景是指交换机设备的接口之间不是直接相连，这时每个接口的邻居不止一个。多邻居组网如下图所示，SwitchA、SwitchB和SwitchC之间通过Switch连接（Switch需要支持LLDP报文透传）。这样SwitchA、SwitchB和SwitchC的接口都不止有一个邻居。

![多邻居组网应用场景](https://download.huawei.com/mdl/image/download?uuid=5006a1cc505742e89194058d4003a60b)



### 链路聚合组网

链路聚合组网应用场景是指交换机设备的接口之间存在链路聚合，接口之间是直接相连，链路聚合之间的每个接口只有一个邻居设备。如下图所示SwitchA和SwitchB之间存在链路聚合，SwitchA和SwitchB的每一个接口都只有一个邻居。

![链路聚合组网应用场景](https://download.huawei.com/mdl/image/download?uuid=6fd4260d9f454ea8b05657523ce9036c)



----

## 报文格式（帧）

封装有LLDP数据单元**LLDPDU**（LLDP Data Unit）的以太网报文称为LLDP报文。其封装格式有两种：
- **Ethernet II** （结构简洁且兼容性强，一般基于这种）
- **802.3 LLC SNAP**（LLC，即LLC头部）（SNAP，Subnetwork Access Protocol，子网访问协议）（特定旧设备互通场景下）



| 字段 | 长度     | 含义                                                         |
| ---- | -------- | ------------------------------------------------------------ |
| DMAC | 6字节    | LLDP帧的目的MAC地址。<br/>IEEE 802.1AB规定可以取如下3种值：<br/>- 0x0180-C200-000E: 最近网桥（Nearest Bridge）组MAC地址。<br/>- 0x0180-C200-0003: 最近的非两端口MAC中继网桥（Nearest non-TPMR Bridge）组地址。<br/>- 0x0180-C200-0000: 最近的客户网桥（Nearest Customer Bridge）组MAC地址。<br/>在使用VRP ®（Versatile Routing Platform）软件的华为设备上，LLDP帧的目的MAC地址取值为0x0180-C200-000E。 |
| SMAC | 6字节    | 源MAC地址，为端口MAC地址或设备桥MAC地址（如果有端口地址则使用端口MAC地址，否则使用设备桥MAC地址）。 |
| Type | 2或8字节 | 协议类型：<br/>- 如果是Ethernet II封装，值为0x88CC。<br/>- 如果是802.3 LLC SNAP封装，值为0xAAAA-0300-0000-88CC。 |
| Data / LLDPDU | 变长     | 数据字段，标识帧的负载，为LLDPDU。LLDPDU就是封装在LLDP报文数据部分的数据单元。在组成LLDPDU之前，设备先将本地信息封装成TLV格式，再由若干个TLV组合成一个LLDPDU封装在LLDP报文的数据部分进行传送。 |
| FCS  | 4字节    | 帧校验序列FCS（Frame Check Sequence）是为接收网卡提供判断是否传输错误的一种方法，如果发现错误，丢弃此帧。FCS只是通用叫法，具体的FCS还可以细分多种校验方法。在以太帧中，FCS通常采用循环冗余码校验CRC（Cyclical Redundancy Check）。 |



### LLDPDU


#### LLDPDU组成 - TLV

LLDPDU就是封装在LLDP报文中本地信息的数据单元。在组成LLDPDU之前，先将本地信息封装成TLV(Type/Length/Value)格式，再由若干个TLV组合成一个LLDPDU封装在LLDP报文的数据部分进行传送。

**结构如下：**

| No | TLV | Required |
| -- | --- | -------- |
| 1  | Chassis ID TLV | Yes |
| 2  | Port ID TLV | Yes |
| 3  | Time to Live (TTL) TLV | Yes |
| 4  | Optional TLV | No |
| ...  | ... | .. |
| n-1  | Optional TLV | No |
| n  | End of LLDPDU TLV | Yes |



#### TLV结构

- TLV Type [7bit]：TLV的类型，每个TLV的类型值不同，比如End of LLDPDU TLV的类型值为0，Chassis ID TLV的类型值为1等。

- TLV Length [9bit]：TLV的长度，占9个bit。

- TLV Value [0-511byte]：TLV的值，第一个字节指此TLV的子类型，剩余的字节为TLV真正的值。



#### TLV类型

**IEEE 802.1AB 标准 中将TLV分为：**

- 基本TLV（Basic TLV）

- 组织TLV（Organizationally Specific TLVs）
  - 802.1组织定义的TLV
  - 802.3组织定义的TLV
  - 媒体终端发现MED（Media Endpoint Discovery）TLV

- 保留TLV



##### 基本TLV

| TLV名称                 | 说明                                                         | 是否必须发布 |
| ----------------------- | ------------------------------------------------------------ | ------------ |
| Chassis ID TLV          | 发送设备的桥MAC地址。                                        | 是           |
| Port ID TLV             | 标识LLDPDU发送端的端口，内容为端口名称。                     | 是           |
| Time To Live TLV        | 本设备信息在邻居设备上的存活时间。                           | 是           |
| End of LLDPDU TLV       | 标志LLDPDU结束。                                             | 是           |
| Port Description TLV    | 以太网端口的描述字符串。                                     | 否           |
| System Name TLV         | 设备名称。**说明：**如果设备上已执行**ip domain-name**命令为设备名称添加后缀，则该TLV显示为“设备名称.后缀”。例如，设备名称为**MyDevice**，后缀为**area1**，则该TLV为**MyDevice.area1**。 | 否           |
| System Description TLV  | 系统描述。                                                   | 否           |
| System Capabilities TLV | 系统的主要功能以及有哪些主要功能被使能。                     | 否           |
| Management Address TLV  | 供网管系统标识网络设备并进行管理的地址。管理地址可以明确地标识一台设备，有利于网络拓扑的绘制，便于网络管理。 | 否           |



##### 组织TLV - 802.1

| TLV名称                       | 说明                 |
| ----------------------------- | -------------------- |
| Port VLAN ID TLV              | 端口VLAN ID。        |
| Port And Protocol VLAN ID TLV | 端口的协议VLAN ID。  |
| VLAN Name TLV                 | 端口VLAN名称。       |
| Protocol Identity TLV         | 端口支持的协议类型。 |



##### 组织TLV - 802.3



| TLV名称                          | 说明                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| EEE TLV                          | 端口是否支持EEE（Energy Efficient Ethernet）功能。           |
| Link Aggregation TLV             | 端口是否支持链路聚合以及是否已使能链路聚合。                 |
| MAC/PHY Configuration/Status TLV | 端口的速率和双工状态、是否支持端口速率自动协商、是否已使能自动协商功能以及当前的速率和双工状态。 |
| Maximum Frame Size TLV           | 端口支持的最大帧长度，取端口最大传输单元MTU（Max Transmission Unit）。 |
| Power Via MDI TLV                | 端口的供电能力，比如是否支持https://info.support.huawei.com/info-finder/encyclopedia/zh/PoE.html，是供电设备还是受电设备。 |



##### 组织TLV - MED

MED TLV为VoIP（Voice over IP）提供了许多高级的应用，包括基本配置、网络策略配置、地址信息以及目录管理等，满足了语音设备的不同生产厂商在成本有效、易部署性、易管理性等方面的要求，并解决了在以太网中部署语音设备的问题，为语音设备的生产者、销售者以及使用者提供便利。

当交换机识别到其某一接口的LLDP邻居发送的LLDP报文中包含任一类型的MED TLV时，交换机会将该接口能发布的所有MED TLV均发布给该LLDP邻居。但该LLDP邻居可能仅支持交换机发布的部分MED TLV，此时会导致LLDP协商失败。可以通过执行undo lldp tlv-enable med-tlv命令配置该接口不发布其LLDP邻居不支持的MED TLV。例如，某终端不支持802.3af标准，即无法识别Extended Power-via-MDI TLV，则必须在连接该终端的接口下执行undo lldp tlv-enable med-tlv power-over-ethernet命令配置该接口不发布Extended Power-via-MDI TLV。

| TLV名称                     | 说明                                                       |
| --------------------------- | ---------------------------------------------------------- |
| LLDP-MED Capabilities TLV   | 当前设备的设备类型以及在LLDPDU中可封装的LLDP-MED TLV类型。 |
| Inventory TLV               | 设备的制造厂商。                                           |
| Location Identification TLV | 位置标识信息，供其它设备发现设备的位置。                   |
| Network Policy TLV          | Voice VLAN的VLAN ID、二层优先级以及DSCP值等。              |
| Extended Power-via-MDI TLV  | 当前设备的供电能力。                                       |
| Hardware Revision TLV       | 媒体终端ME（Media Endpoint）设备的硬件版本。               |
| Firmware Revision TLV       | ME设备的硬件版本。                                         |
| Software Revision TLV       | ME设备的软件版本。                                         |
| Serial Number TLV           | ME设备的序列号。                                           |
| Model Name TLV              | ME设备的Model Name。                                       |
| Asset ID TLV                | ME设备的资产标识符。                                       |



----

## 协商机制


### LLDP报文发送机制

当使能LLDP功能时，设备会**周期性**地向邻居设备发送LLDP报文。如果设备的**本地配置发生变化**则**立即发送**LLDP报文，以将本地信息的变化情况尽快通知给邻居设备。为了防止本地信息的频繁变化而引起LLDP报文的大量发送，每发送一个LLDP报文后都需**延迟**一段时间后再继续发送下一个报文。

当接口的状态发生变化（去使能LLDP、接口shutdown）时，接口会向邻居设备发送一个LLDP报文，其中TTL TLV (Time To Live TLV)字段的Value值为0，这个报文称为shutdown报文。shutdown报文不包含任何可选TLV。


### LLDP报文接收机制

当使能LLDP功能时，设备会对收到的LLDP报文及其携带的TLV进行**有效性检查**，通过检查后再将邻居信息保存到本地设备，并根据LLDPDU报文中TLV携带的TTL值设置邻居信息在本地设备的**老化时间**。如果接收到的LLDPDU中的**TTL值等于零**，将**立刻老化**掉该邻居信息。



----

## 实现原理

LLDP可以将本地设备的信息组织起来并发布给自己的远端设备，本地设备将收到的远端设备信息以标准MIB的形式保存起来。工作原理如下：

![LLDP原理框图](https://download.huawei.com/mdl/image/download?uuid=7ebd198003e24073b6bf421c684ad8c0)


LLDP本地系统MIB用来保存本地设备信息。包括设备ID、接口ID、系统名称、系统描述、接口描述、网络管理地址等信息。

LLDP远端系统MIB用来保存远端设备信息。包括设备ID、接口ID、系统名称、系统描述、接口描述、网络管理地址等信息。



**LLDP基本实现原理为：**

1. LLDP模块通过LLDP代理与设备上物理拓扑MIB、实体MIB、接口MIB以及其他类型MIB的交互，来更新自己的LLDP本地系统MIB，以及本地设备自定义的LLDP扩展MIB。

2. 将本地设备信息封装成LLDP帧发送给远端设备。

3. 接收远端设备发过来的LLDP帧，更新自己的LLDP远端系统MIB，以及远端设备自定义的LLDP扩展MIB。

4. 通过LLDP代理收发LLDP帧，设备就很清楚地知道远端设备的信息，包括连接的是远端设备的哪个接口、远端设备的MAC地址等信息。



**LLDP代理完成下列任务:**

- 维护LLDP本地系统MIB和LLDP远端系统MIB。

- 在本地状态发生变化的情况下，提取LLDP本地系统MIB信息并向远端设备发送。在本地设备状态信息没有变化的情况下，按照一定的周期提取LLDP本地系统MIB信息向远端设备发送。

- 识别并处理收到的LLDP帧。

- LLDP本地系统MIB或LLDP远端系统MIB的状态发生变化的情况下，向网管发送LLDP告警。








----

> - [Reference Doc 1](https://support.huawei.com/enterprise/zh/doc/EDOC1100174722/9f322d1)
> - [Reference Doc 2](https://info.support.huawei.com/info-finder/encyclopedia/zh/LLDP.html)
> - [Reference Doc 3](https://info.support.huawei.com/info-finder/encyclopedia/zh/%E7%BB%84%E6%92%AD.html)

