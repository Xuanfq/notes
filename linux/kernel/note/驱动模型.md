# 驱动模型

Refer:

- [Driver implementer’s API guide — The Linux Kernel documentation](https://www.kernel.org/doc/html/latest/driver-api/index.html)
- [Driver Model — The Linux Kernel documentation](https://www.kernel.org/doc/html/latest/driver-api/driver-model/index.html)


## 驱动绑定

驱动程序绑定是将设备与能够控制它的设备驱动程序相关联的过程。通常由`总线驱动程序来处理这个问题`，因为一直存在特定于总线的结构来表示设备和驱动程序。有了通用的设备和设备驱动程序结构，大部分绑定都可以使用通用代码来完成。

### 1. Bus

`Bus` 包含:
- `Device`: 由 `device_register` 插入 Bus 列表
- `Driver`: 由 `driver_register` 插入 Bus 列表

总线类型结构包含系统中该总线类型上所有设备的列表。

当为某个设备调用device_register时，该设备会被插入到此列表的末尾。

总线对象还包含该总线类型所有驱动程序的列表。

当为某个驱动程序调用driver_register时，该驱动程序会被插入到此列表的末尾。这两个事件会触发驱动程序绑定。


### 2. device_register

当`添加新设备`时，会遍历总线的驱动程序列表，以找到一个支持该设备的驱动程序。

为了确定这一点，设备的设备ID必须与驱动程序支持的设备ID之一相匹配。比较ID的格式和语义因总线而异。

与其尝试推导复杂的状态机和匹配算法，不如由总线`驱动程序`提供一个`回调函数`(`.match`)，将设备与驱动程序的ID进行比较。如果找到匹配项，总线返回1；否则返回0。

```
int match(struct device * dev, struct device_driver * drv);
```

如果找到匹配项，设备的驱动程序字段将`设置为该驱动程序`，并且会`调用驱动程序的探测回调函数`(`.probe`)。这使驱动程序有机会验证其`是否真正支持该硬件`，以及该`硬件是否处于工作状态`。


### 3. Device Class

在成功完成`探测`(`.probe`)后，`设备`会向其`所属的类`注册。设备驱动程序只属于一个类，这个类在`驱动程序`的`devclass`字段中设置。调用`devclass_add_device`函数在类中枚举设备，并通过类的`register_dev`回调函数`实际向该类注册设备`。


### 4. Driver

当一个驱动程序附加到一个设备时，该设备会被插入到驱动程序的设备列表中。


### 5. sysfs

在`总线`的“devices”目录中会创建一个`符号链接`，它指向`物理层级结构中设备的目录`。

在`驱动程序`的“devices”目录中会创建一个`符号链接`，它指向`物理层级结构中设备的目录`。

在`类的目录`中会为该设备创建一个目录。在该目录中会创建一个`符号链接`，它指向该设备在`sysfs树中的物理位置`。

可以在设备的`物理目录`中创建一个`符号链接`，该符号链接可以指向其`类目录`，也可以指向`该类的顶级目录`。还可以创建一个符号链接指向其`驱动程序目录`。（尽管目前尚未实现，上面的总线、驱动程序都有链接到物理位置，单向是实现了，双向得看Linux版本history什么时候实现）


### 6. driver_register

`添加新驱动程序`时的过程几乎相同。会`遍历总线`上的设备列表以找到匹配项。`已拥有驱动程序的设备将被跳过`。会遍历所有设备，以便尽可能多地将设备绑定到该驱动程序。


### 7. Removal

当一个`设备被移除`时，其引用`计数最终会归零`。当引用计数为零时，会`调用驱动程序的移除回调函数`。该设备会从驱动程序的设备列表中移除，并且`驱动程序的引用计数会减一`。两者之间的`所有符号链接都会被移除`。

当`移除一个驱动程序`时，会`遍历它所支持的设备列表`，并`为每个设备调用驱动程序的移除回调函数`。设备会从该列表中移除，同时符号链接也会被删除。



## Bus Type

### Definition


```c
// include/linux/device.h
struct bus_type {
	const char		*name;              // bus 名
	const char		*dev_name;          // 用于子系统枚举设备的表达式，如 `sprint(buffer, "foo%u", dev->id)`
	struct device		*dev_root;      // 用作父(设备)的默认设备。
	const struct attribute_group **bus_groups;      // 总线的默认属性。
	const struct attribute_group **dev_groups;      // 总线上设备的默认属性。
	const struct attribute_group **drv_groups;      // 总线上设备驱动的默认属性。

	int (*match)(struct device *dev, struct device_driver *drv);
	int (*uevent)(struct device *dev, struct kobj_uevent_env *env);
	int (*probe)(struct device *dev);
	int (*remove)(struct device *dev);
	void (*shutdown)(struct device *dev);

	int (*online)(struct device *dev);
	int (*offline)(struct device *dev);

	int (*suspend)(struct device *dev, pm_message_t state);
	int (*resume)(struct device *dev);

	int (*num_vf)(struct device *dev);

	int (*dma_configure)(struct device *dev);

	const struct dev_pm_ops *pm;

	const struct iommu_ops *iommu_ops;

	struct subsys_private *p;
	struct lock_class_key lock_key;

	bool need_parent_lock;
};

extern int __must_check bus_register(struct bus_type *bus);
```


