# å†…å­˜æ¨¡å‹

å¾ˆå¤šäººå°†ã€java å†…å­˜ç»“æ„ã€‘ä¸ã€java å†…å­˜æ¨¡å‹ã€‘å‚»å‚»åˆ†ä¸æ¸…ï¼Œã€java å†…å­˜æ¨¡å‹ã€‘æ˜¯ Java Memory Modelï¼ˆJMMï¼‰çš„æ„æ€ã€‚

å…³äºå®ƒçš„æƒå¨è§£é‡Šï¼Œè¯·å‚è€ƒhttps://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b

**ç®€å•çš„è¯´ï¼ŒJMM å®šä¹‰äº†ä¸€å¥—åœ¨å¤šçº¿ç¨‹è¯»å†™å…±äº«æ•°æ®æ—¶ï¼ˆæˆå‘˜å˜é‡ã€æ•°ç»„ï¼‰æ—¶ï¼Œå¯¹æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸå­æ€§çš„è§„åˆ™å’Œä¿éšœã€‚**



## JMM

### 1. ä»€ä¹ˆæ˜¯JMM

å› ä¸ºåœ¨ä¸åŒçš„ç¡¬ä»¶ç”Ÿäº§å•†å’Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¸‹ï¼Œå†…å­˜çš„è®¿é—®æœ‰ä¸€å®šçš„å·®å¼‚ï¼Œæ‰€ä»¥ä¼šé€ æˆç›¸åŒçš„ä»£ç è¿è¡Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šä¼šå‡ºç°å„ç§é—®é¢˜ã€‚æ‰€ä»¥**javaå†…å­˜æ¨¡å‹(JMM)å±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å¹¶å‘æ•ˆæœã€‚**

Javaå†…å­˜æ¨¡å‹è§„å®š**æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜**ä¸­ï¼ŒåŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œé™æ€å˜é‡ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡å’Œæ–¹æ³•å‚æ•°ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œ**çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¿å­˜äº†è¯¥çº¿ç¨‹ç”¨åˆ°çš„å˜é‡å’Œä¸»å†…å­˜çš„å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ“ä½œéƒ½åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œ**ã€‚**çº¿ç¨‹ä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡**ã€‚

ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¹Ÿæ— æ³•è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ã€‚çº¿ç¨‹ä¹‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚

![image-20220809162138856](https://img2022.cnblogs.com/blog/2950406/202208/2950406-20220812111135245-870690023.png)

æ¯ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œçº¿ç¨‹æ“ä½œæ•°æ®åªèƒ½åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œç„¶ååˆ·å›åˆ°ä¸»å­˜ã€‚è¿™æ˜¯ Java å†…å­˜æ¨¡å‹å®šä¹‰çš„çº¿ç¨‹åŸºæœ¬å·¥ä½œæ–¹å¼ã€‚



### 2. JMMå®šä¹‰äº†ä»€ä¹ˆ

æ•´ä¸ªJavaå†…å­˜æ¨¡å‹å®é™…ä¸Šæ˜¯å›´ç»•ç€ä¸‰ä¸ªç‰¹å¾å»ºç«‹èµ·æ¥çš„ã€‚åˆ†åˆ«æ˜¯ï¼š**åŸå­æ€§ï¼Œå¯è§æ€§ï¼Œæœ‰åºæ€§**ã€‚è¿™ä¸‰ä¸ªç‰¹å¾å¯è°“æ˜¯æ•´ä¸ªJavaå¹¶å‘çš„åŸºç¡€ã€‚

#### åŸå­æ€§

åŸå­æ€§æŒ‡çš„æ˜¯ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†å‰²ï¼Œä¸å¯ä¸­æ–­çš„ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚

**é¢è¯•å®˜æ‹¿ç¬”å†™äº†æ®µä»£ç ï¼Œä¸‹é¢è¿™å‡ å¥ä»£ç èƒ½ä¿è¯åŸå­æ€§å—**ï¼Ÿ

```text
int i = 2;
int j = i;
i++;
i = i + 1;
```

ç¬¬ä¸€å¥æ˜¯åŸºæœ¬ç±»å‹èµ‹å€¼æ“ä½œï¼Œå¿…å®šæ˜¯åŸå­æ€§æ“ä½œã€‚

ç¬¬äºŒå¥å…ˆè¯»å–içš„å€¼ï¼Œå†èµ‹å€¼åˆ°jï¼Œä¸¤æ­¥æ“ä½œï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ã€‚

ç¬¬ä¸‰å’Œç¬¬å››å¥å…¶å®æ˜¯ç­‰æ•ˆçš„ï¼Œå…ˆè¯»å–içš„å€¼ï¼Œå†+1ï¼Œæœ€åèµ‹å€¼åˆ°iï¼Œä¸‰æ­¥æ“ä½œäº†ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ã€‚

JMMåªèƒ½ä¿è¯åŸºæœ¬çš„åŸå­æ€§ï¼Œå¦‚æœè¦ä¿è¯ä¸€ä¸ªä»£ç å—çš„åŸå­æ€§ï¼Œæä¾›äº†monitorenter å’Œ moniterexit ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ synchronized å…³é”®å­—ã€‚å› æ­¤åœ¨ synchronized å—ä¹‹é—´çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚

#### å¯è§æ€§

å¯è§æ€§æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çŸ¥é“è¢«ä¿®æ”¹äº†ã€‚Javaæ˜¯åˆ©ç”¨volatileå…³é”®å­—æ¥æä¾›å¯è§æ€§çš„ã€‚ å½“å˜é‡è¢«volatileä¿®é¥°æ—¶ï¼Œè¿™ä¸ªå˜é‡è¢«ä¿®æ”¹åä¼šç«‹åˆ»åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œå½“å…¶å®ƒçº¿ç¨‹éœ€è¦è¯»å–è¯¥å˜é‡æ—¶ï¼Œä¼šå»ä¸»å†…å­˜ä¸­è¯»å–æ–°å€¼ã€‚è€Œæ™®é€šå˜é‡åˆ™ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ã€‚

é™¤äº†volatileå…³é”®å­—ä¹‹å¤–ï¼Œfinalå’Œsynchronizedä¹Ÿèƒ½å®ç°å¯è§æ€§ã€‚

synchronizedçš„åŸç†æ˜¯ï¼Œåœ¨æ‰§è¡Œå®Œï¼Œè¿›å…¥unlockä¹‹å‰ï¼Œå¿…é¡»å°†å…±äº«å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ã€‚

finalä¿®é¥°çš„å­—æ®µï¼Œä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå¦‚æœæ²¡æœ‰å¯¹è±¡é€¸å‡ºï¼ˆæŒ‡å¯¹è±¡ä¸ºåˆå§‹åŒ–å®Œæˆå°±å¯ä»¥è¢«åˆ«çš„çº¿ç¨‹ä½¿ç”¨ï¼‰ï¼Œé‚£ä¹ˆå¯¹äºå…¶ä»–çº¿ç¨‹éƒ½æ˜¯å¯è§çš„ã€‚

#### æœ‰åºæ€§

åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨synchronizedæˆ–è€…volatileä¿è¯å¤šçº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ã€‚å®ç°åŸç†æœ‰äº›åŒºåˆ«ï¼š

volatileå…³é”®å­—æ˜¯ä½¿ç”¨å†…å­˜å±éšœè¾¾åˆ°ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œä»¥ä¿è¯æœ‰åºæ€§ã€‚

synchronizedçš„åŸç†æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹lockä¹‹åï¼Œå¿…é¡»unlockåï¼Œå…¶ä»–çº¿ç¨‹æ‰å¯ä»¥é‡æ–°lockï¼Œä½¿å¾—è¢«synchronizedåŒ…ä½çš„ä»£ç å—åœ¨å¤šçº¿ç¨‹ä¹‹é—´æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚



### 3. å…«ç§å†…å­˜äº¤äº’æ“ä½œ

![image-20220809163201959](https://img2022.cnblogs.com/blog/2950406/202208/2950406-20220812111135471-1693508299.png)

- lock(é”å®š)ï¼Œä½œç”¨äº**ä¸»å†…å­˜**ä¸­çš„å˜é‡ï¼ŒæŠŠå˜é‡æ ‡è¯†ä¸ºçº¿ç¨‹ç‹¬å çš„çŠ¶æ€ã€‚
- read(è¯»å–)ï¼Œä½œç”¨äº**ä¸»å†…å­˜**çš„å˜é‡ï¼ŒæŠŠå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€æ­¥çš„loadæ“ä½œä½¿ç”¨ã€‚
- load(åŠ è½½)ï¼Œä½œç”¨äº**å·¥ä½œå†…å­˜**çš„å˜é‡ï¼ŒæŠŠreadæ“ä½œä¸»å­˜çš„å˜é‡æ”¾å…¥åˆ°å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚
- use(ä½¿ç”¨)ï¼Œä½œç”¨äº**å·¥ä½œå†…å­˜**çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ä¼ è¾“åˆ°æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨åˆ°å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚
- assign(èµ‹å€¼)ï¼Œä½œç”¨äº**å·¥ä½œå†…å­˜**çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“ä¸­æ¥å—åˆ°çš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚
- store(å­˜å‚¨)ï¼Œä½œç”¨äº**å·¥ä½œå†…å­˜**çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»å·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿åç»­çš„writeä½¿ç”¨ã€‚
- write(å†™å…¥)ï¼šä½œç”¨äº**ä¸»å†…å­˜**ä¸­çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚
- unlock(è§£é”)ï¼šä½œç”¨äº**ä¸»å†…å­˜**çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚

JMMå¯¹8ç§å†…å­˜äº¤äº’æ“ä½œåˆ¶å®šçš„è§„åˆ™ï¼š

- ä¸å…è®¸readã€loadã€storeã€writeæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œä¹Ÿå°±æ˜¯readæ“ä½œåå¿…é¡»loadï¼Œstoreæ“ä½œåå¿…é¡»writeã€‚
- ä¸å…è®¸çº¿ç¨‹ä¸¢å¼ƒä»–æœ€è¿‘çš„assignæ“ä½œï¼Œå³å·¥ä½œå†…å­˜ä¸­çš„å˜é‡æ•°æ®æ”¹å˜äº†ä¹‹åï¼Œå¿…é¡»å‘ŠçŸ¥ä¸»å­˜ã€‚
- ä¸å…è®¸çº¿ç¨‹å°†æ²¡æœ‰assignçš„æ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ã€‚
- ä¸€ä¸ªæ–°çš„å˜é‡å¿…é¡»åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸å·¥ä½œå†…å­˜ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–çš„å˜é‡ã€‚å°±æ˜¯å¯¹å˜é‡å®æ–½useã€storeæ“ä½œä¹‹å‰ï¼Œå¿…é¡»ç»è¿‡loadå’Œassignæ“ä½œã€‚
- ä¸€ä¸ªå˜é‡åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å…¶è¿›è¡Œlockæ“ä½œã€‚å¤šæ¬¡lockä¹‹åï¼Œå¿…é¡»æ‰§è¡Œç›¸åŒæ¬¡æ•°unlockæ‰å¯ä»¥è§£é”ã€‚
- å¦‚æœå¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œlockæ“ä½œï¼Œä¼šæ¸…ç©ºæ‰€æœ‰å·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ã€‚åœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œå¿…é¡»é‡æ–°loadæˆ–assignæ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚
- å¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰è¢«lockï¼Œå°±ä¸èƒ½å¯¹å…¶è¿›è¡Œunlockæ“ä½œã€‚ä¹Ÿä¸èƒ½unlockä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”ä½çš„å˜é‡ã€‚
- ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ã€‚

....





## 1. åŸå­æ€§

### 1.1 æå‡ºé—®é¢˜

åŸå­æ€§åœ¨å­¦ä¹ çº¿ç¨‹æ—¶è®²è¿‡ï¼Œä¸‹é¢æ¥ä¸ªä¾‹å­ç®€å•å›é¡¾ä¸€ä¸‹ï¼š

é—®é¢˜æå‡ºï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ



### 1.2 é—®é¢˜åˆ†æ

ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œã€‚

ä¾‹å¦‚å¯¹äº `i++` è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š

```java
getstatic     i  // è·å–é™æ€å˜é‡içš„å€¼ 
iconst_1         // å‡†å¤‡å¸¸é‡1
iadd             // åŠ æ³•
putstatic     i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œ `i--`å¯¹åº” ä¹Ÿæ˜¯ç±»ä¼¼ï¼š

```java
getstatic     i  // è·å–é™æ€å˜é‡içš„å€¼ 
iconst_1         // å‡†å¤‡å¸¸é‡1
isub             // å‡æ³•
putstatic     i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦åœ¨ä¸»å­˜å’Œçº¿ç¨‹å†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š

![image-20220809093358513](https://img2022.cnblogs.com/blog/2950406/202208/2950406-20220812111134469-2087370755.png)

å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic     i  // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼    çº¿ç¨‹å†…i=0 
iconst_1         // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd             // çº¿ç¨‹1-è‡ªå¢    çº¿ç¨‹å†…i=1
putstatic     i  // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1 
getstatic     i  // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼    çº¿ç¨‹å†…i=1
iconst_1         // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1 
isub             // çº¿ç¨‹1-è‡ªå‡    çº¿ç¨‹å†…i=0
putstatic     i // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=0
```

ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½äº¤é”™è¿è¡Œï¼ˆä¸ºä»€ä¹ˆä¼šäº¤é”™ï¼Ÿæ€è€ƒä¸€ä¸‹ï¼‰ï¼š

å‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic     i // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
getstatic     i // çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
iconst_1         // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd             // çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1
putstatic     i  // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1 
iconst_1         // çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1
isub             // çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1
putstatic     i // çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1
```

å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic     i // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
getstatic     i // çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
iconst_1         // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd             // çº¿ç¨‹1-è‡ªå¢    çº¿ç¨‹å†…i=1 
iconst_1         // çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1 
isub             // çº¿ç¨‹2-è‡ªå‡    çº¿ç¨‹å†…i=-1
putstatic     i  // çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1 
putstatic     i  // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1
```



### 1.3 è§£å†³æ–¹æ³•

`synchronized` ï¼ˆåŒæ­¥å…³é”®å­—ï¼‰ 

è¯­æ³•

```java
synchronized( å¯¹è±¡ ) { 
	è¦ä½œä¸ºåŸå­æ“ä½œä»£ç 
}
```

ç”¨ `synchronized` è§£å†³å¹¶å‘é—®é¢˜ï¼š

```java
static int i = 0;
static Object obj = new Object();
public static void main(String[] args) throws InterruptedException { 
   Thread t1 = new Thread(() -> {
       for (int j = 0; j < 5000; j++) { 
           synchronized (obj) {
               i++; 
           }
       } 
   });
   Thread t2 = new Thread(() -> {
       for (int j = 0; j < 5000; j++) { 
           synchronized (obj) {
               i--; 
           }
       }
   });
   t1.start(); 
   t2.start();
   t1.join(); 
   t2.join();
   System.out.println(i); 
}
```

å¦‚ä½•ç†è§£å‘¢ï¼šä½ å¯ä»¥æŠŠ obj æƒ³è±¡æˆä¸€ä¸ªæˆ¿é—´ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäººã€‚

å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(obj) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶åæ‰‹é”ä½äº†é—¨ï¼Œåœ¨é—¨å†…æ‰§è¡Œ count++ ä»£ç ã€‚

è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(obj) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ã€‚

å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šè§£å¼€é—¨ä¸Šçš„é”ï¼Œä» obj æˆ¿é—´å‡ºæ¥ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œåé”ä½é—¨ï¼Œæ‰§è¡Œå®ƒçš„ count\-- ä»£ç ã€‚

> æ³¨æ„ï¼šä¸Šä¾‹ä¸­ t1 å’Œ t2 çº¿ç¨‹å¿…é¡»ç”¨ synchronized é”ä½åŒä¸€ä¸ª obj å¯¹è±¡ï¼Œå¦‚æœ t1 é”ä½çš„æ˜¯ m1 å¯¹è±¡ï¼Œt2 é”ä½çš„æ˜¯ m2 å¯¹è±¡ï¼Œå°±å¥½æ¯”ä¸¤ä¸ªäººåˆ†åˆ«è¿›å…¥äº†ä¸¤ä¸ªä¸åŒçš„æˆ¿é—´ï¼Œæ²¡æ³•èµ·åˆ°åŒæ­¥çš„æ•ˆæœã€‚





## 2. å¯è§æ€§

### 2.1 é€€ä¸å‡ºçš„å¾ªç¯

å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š

```java
static boolean run = true;
public static void main(String[] args) throws InterruptedException { 
   Thread t = new Thread(()->{
       while(run){ 
           // .... 
       }
   });
   t.start();
   Thread.sleep(1000);
   run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥ 
}
```



ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä¸€ä¸‹ï¼š

1.åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚

![image-20220809093916582](https://img2022.cnblogs.com/blog/2950406/202208/2950406-20220812111134669-1129571784.png)

2.å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡

![image-20220809093957418](https://img2022.cnblogs.com/blog/2950406/202208/2950406-20220812111134864-1326205463.png)

3.1ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼

![image-20220809094105438](https://img2022.cnblogs.com/blog/2950406/202208/2950406-20220812111135037-1802135917.png)



### 2.2 è§£å†³æ–¹æ³•

volatileï¼ˆæ˜“å˜å…³é”®å­—ï¼‰

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ° ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜



### 2.3 å¯è§æ€§

å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œ ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µï¼š

ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„ï¼š

```java
getstatic     run   // çº¿ç¨‹    t è·å–    run true
getstatic     run   // çº¿ç¨‹    t è·å–    run true
getstatic     run   // çº¿ç¨‹    t è·å–    run true
getstatic     run   // çº¿ç¨‹    t è·å–    run true
putstatic     run  //  çº¿ç¨‹    main ä¿®æ”¹    run ä¸º    falseï¼Œ    ä»…æ­¤ä¸€æ¬¡ 
getstatic     run   // çº¿ç¨‹    t è·å–    run false
```

æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i\-- ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic     i // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
getstatic     i // çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0 
iconst_1         // çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd             // çº¿ç¨‹1-è‡ªå¢    çº¿ç¨‹å†…i=1
putstatic     i  // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1 
iconst_1         // çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1
isub             // çº¿ç¨‹2-è‡ªå‡    çº¿ç¨‹å†…i=-1
putstatic     i // çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1
```

> **æ³¨æ„**
>
> synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯**ä»£ç å—**çš„**åŸå­æ€§**ï¼Œä¹ŸåŒæ—¶ä¿è¯**çº¿ç¨‹ä»£ç å—å†…å…±äº«å˜é‡**çš„**å¯è§æ€§**ã€‚ä½†ç¼ºç‚¹æ˜¯ synchronizedæ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½ã€‚
>
> - 1.çº¿ç¨‹åŠ é”æ—¶ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼
>
> - 2.çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­(æ³¨æ„ï¼šåŠ é”ä¸è§£é”éœ€è¦åŒä¸€æŠŠé”)
>
> - çº¿ç¨‹è§£é”å‰å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹åœ¨ä¸‹æ¬¡åŠ é”æ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§
>
>   çº¿ç¨‹æ‰§è¡Œäº’æ–¥ä»£ç çš„è¿‡ç¨‹
>
>   1. è·å–äº’æ–¥é”
>   2. æ¸…ç©ºå·¥ä½œå†…å­˜
>   3. ä»ä¸»å†…å­˜æ‹·è´å˜é‡çš„æœ€æ–°å‰¯æœ¬åˆ°å·¥ä½œå†…å­˜
>   4. æ‰§è¡Œä»£ç 
>   5. å°†æ›´æ”¹åçš„å…±äº«å˜é‡çš„å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜
>   6. é‡Šæ”¾äº’æ–¥é”
>
> å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ°å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿ
>
> - çº¿ç¨‹åŠ é”æ—¶ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä¸‹æ¬¡å¾ªç¯æ—¶ä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ false





## 3.æœ‰åºæ€§

### 3.1 è¯¡å¼‚çš„ç»“æœ

```java
int num = 0;
boolean ready = false; 
// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor1(I_Result r) { 
   if(ready) {
       r.r1 = num + num; 
   } else {
       r.r1 = 1; 
   }
}
// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor2(I_Result r) { 
   num = 2;
   ready = true; 
}
```

I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ 

æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ

æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1

æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1

æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰



ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§ï¼

è¿™ç§æƒ…å†µä¸‹æ˜¯ï¼šçº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œ num = 2

ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ



è¿™ç§ç°è±¡å«åš**æŒ‡ä»¤é‡æ’**ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼š å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress [https://wiki.openjdk.java.net/display/CodeTools/jcstress](https://wiki.openjdk.java.net/display/CodeTools/jcstress)

```sh
mvn archetype:generate  -DinteractiveMode=false -
DarchetypeGroupId=org.openjdk.jcstress -DarchetypeArtifactId=jcstress-java-test- 
archetype -DgroupId=org.sample -DartifactId=test -Dversion=1.0
```

åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»

```java
@JCStressTest
@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!") 
@State
public class ConcurrencyTest { 
   int num = 0;
   boolean ready = false; 
   @Actor
   public void actor1(I_Result r) { 
       if(ready) {
           r.r1 = num + num; 
       } else {
           r.r1 = 1; 
       }
   }
   @Actor
   public void actor2(I_Result r) { 
       num = 2;
       ready = true; 
   }
}
```

æ‰§è¡Œ

```sh
mvn clean install
java -jar target/jcstress.jar
```

ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š

```sh
*** INTERESTING tests
Some interesting behaviors observed. This is for the plain curiosity. 
2 matching test results.
     [OK] test.ConcurrencyTest
   (JVM args: [-XX:-TieredCompilation])
Observed state   Occurrences              Expectation  Interpretation
              0         1,729   ACCEPTABLE_INTERESTING  !!!! 
              1    42,617,915               ACCEPTABLE  ok 
              4     5,146,627               ACCEPTABLE  ok
     [OK] test.ConcurrencyTest 
   (JVM args: [])
Observed state   Occurrences              Expectation  Interpretation 
              0         1,652   ACCEPTABLE_INTERESTING  !!!!
              1   46,460,657               ACCEPTABLE ok 
              4     4,571,072               ACCEPTABLE ok
```

å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚



### 3.2 è§£å†³æ–¹æ³•

volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’

```java
@JCStressTest
@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!") 
@State
public class ConcurrencyTest { 
   int num = 0;
   volatile boolean ready = false; 
   @Actor
   public void actor1(I_Result r) { 
       if(ready) {
           r.r1 = num + num; 
       } else {
           r.r1 = 1; 
       }
   }
   @Actor
   public void actor2(I_Result r) { 
       num = 2;
       ready = true; 
   }
}
```

ç»“æœä¸ºï¼š

```sh
*** INTERESTING tests
	Some interesting behaviors observed. This is for the plain curiosity. 
	0 matching test results.
```



### 3.3 æœ‰åºæ€§ç†è§£

JVM ä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ€è€ƒä¸‹é¢ä¸€æ®µä»£ç 

```java
static int i; 
static int j;
// åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ
i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
j = ...;
```

å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œæ—¶ï¼Œæ—¢å¯ä»¥æ˜¯

```java
i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
j = ...;
```

ä¹Ÿå¯ä»¥æ˜¯

```java
j = ...;
i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
```

è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œå¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§ï¼Œä¾‹å¦‚è‘—åçš„ double-checked locking æ¨¡å¼å®ç°å•ä¾‹

```java
public final class Singleton { 
   private Singleton() { }
   private static Singleton INSTANCE = null;
   public static Singleton getInstance() {
       // å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„    synchronizedä»£ç å— 
       if (INSTANCE == null) {            
           synchronized (Singleton.class) {
               // ä¹Ÿè®¸æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡ 
               if (INSTANCE == null) {
                   INSTANCE = new Singleton(); 
               }
           } 
       }
       return INSTANCE; 
   }
}
```

ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š

- æ‡’æƒ°å®ä¾‹åŒ–
- é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”

ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œ INSTANCE = new Singleton() å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š

```java
0: new           #2                  // class cn/itcast/jvm/t4/Singleton 
3: dup
4: invokespecial #3                  // Method "<init>":()V 
7: putstatic     #4                  // Field
INSTANCE:Lcn/itcast/jvm/t4/Singleton;
```

å…¶ä¸­ 4 7 ä¸¤æ­¥çš„é¡ºåºä¸æ˜¯å›ºå®šçš„ï¼Œä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆå°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™ INSTANCE å˜é‡åï¼Œå†æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š

```sh
æ—¶é—´1  t1 çº¿ç¨‹æ‰§è¡Œåˆ°INSTANCE = new Singleton();
æ—¶é—´2  t1 çº¿ç¨‹åˆ†é…ç©ºé—´ï¼Œä¸ºSingletonå¯¹è±¡ç”Ÿæˆäº†å¼•ç”¨åœ°å€ï¼ˆ0 å¤„ï¼‰
æ—¶é—´3  t1 çº¿ç¨‹å°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™INSTANCEï¼Œè¿™æ—¶INSTANCE != nullï¼ˆ7 å¤„ï¼‰
æ—¶é—´4  t2 çº¿ç¨‹è¿›å…¥getInstance()æ–¹æ³•ï¼Œå‘ç°INSTANCE != nullï¼ˆsynchronizedå—å¤–ï¼‰ï¼Œç›´æ¥è¿”å›INSTANCE
æ—¶é—´5  t1 çº¿ç¨‹æ‰§è¡ŒSingletonçš„æ„é€ æ–¹æ³•ï¼ˆ4 å¤„ï¼‰
```

è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹

**å¯¹ INSTANCE ä½¿ç”¨ volatile ä¿®é¥°å³å¯**ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ä¼šçœŸæ­£æœ‰æ•ˆ



### 3.4 happens-before

happens-before è§„å®šäº†å“ªäº›å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼Œ æŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§

- çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§

  ```java
  static int x;
  static Object m = new Object(); 
  new Thread(()->{
     synchronized(m) { 
         x = 10;
     }
  },"t1").start();
  new Thread(()->{
     synchronized(m) {
         System.out.println(x);//t1æ‰§è¡Œå®Œåå†æ‰§è¡Œæ­¤åˆ™ä¸º10
     }
  },"t2").start();
  ```

- çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§

  ```java
  volatile static int x; 
  new Thread(()->{
  	x = 10;
  },"t1").start(); 
  new Thread(()->{
     System.out.println(x); //t1æ‰§è¡Œå®Œåå†æ‰§è¡Œæ­¤åˆ™ä¸º10
  },"t2").start();
  ```

- çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§

  ```java
  static int x; 
  x = 10;
  new Thread(()->{
     System.out.println(x); //10
  },"t2").start();
  ```

- çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ– t1.join()ç­‰å¾…å®ƒç»“æŸï¼‰

  ```java
  static int x;
  Thread t1 = new Thread(()->{ 
     x = 10;
  },"t1"); 
  t1.start();
  t1.join();
  System.out.println(x);//10
  ```

- çº¿ç¨‹ t1 æ‰“æ–­ t2ï¼ˆinterruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡t2.interrupted æˆ– t2.isInterruptedï¼‰

  ```java
  static int x;
  public static void main(String[] args) { 
     Thread t2 = new Thread(()->{
         while(true) {
             if(Thread.currentThread().isInterrupted()) { 
                 System.out.println(x);
                 break; 
             }
         }
     },"t2");
     t2.start();
     new Thread(()->{ 
         try {
             Thread.sleep(1000);
         } catch (InterruptedException e) { 
             e.printStackTrace();
         }
         x = 10;
         t2.interrupt(); 
     },"t1").start();
     while(!t2.isInterrupted()) { 
         Thread.yield();
     }
     System.out.println(x);
  }
  ```

- å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§

- å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ x hb-\> y å¹¶ä¸” y hb-\>z é‚£ä¹ˆæœ‰ x hb-\>zï¼ˆhbï¼šhappens-beforeï¼‰

> å˜é‡éƒ½æ˜¯æŒ‡**æˆå‘˜å˜é‡**æˆ–**é™æ€æˆå‘˜å˜é‡**
>
> å‚è€ƒï¼š ç¬¬17é¡µ





## 4. CAS ä¸ åŸå­ç±»

### 4.1 CAS

CAS å³ Compare and Swap ï¼Œå®ƒä½“ç°çš„ä¸€ç§ä¹è§‚é”çš„æ€æƒ³ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹è¦å¯¹ä¸€ä¸ªå…±äº«çš„æ•´å‹å˜é‡æ‰§è¡Œ +1 æ“ä½œï¼š

```java
// éœ€è¦ä¸æ–­å°è¯• 
while(true) {
 int æ—§å€¼ = å…±äº«å˜é‡; // æ¯”å¦‚æ‹¿åˆ°äº†å½“å‰å€¼ 0
 int ç»“æœ = æ—§å€¼ + 1; // åœ¨æ—§å€¼ 0 çš„åŸºç¡€ä¸Šå¢åŠ  1 ï¼Œæ­£ç¡®ç»“æœæ˜¯ 1 
 /*
   è¿™æ—¶å€™å¦‚æœåˆ«çš„çº¿ç¨‹æŠŠå…±äº«å˜é‡æ”¹æˆäº† 5ï¼Œæœ¬çº¿ç¨‹çš„æ­£ç¡®ç»“æœ 1 å°±ä½œåºŸäº†ï¼Œè¿™æ—¶å€™
   compareAndSwap è¿”å› falseï¼Œé‡æ–°å°è¯•ï¼Œç›´åˆ°ï¼š
   compareAndSwap è¿”å› trueï¼Œè¡¨ç¤ºæˆ‘æœ¬çº¿ç¨‹åšä¿®æ”¹çš„åŒæ—¶ï¼Œåˆ«çš„çº¿ç¨‹æ²¡æœ‰å¹²æ‰° 
 */
 if( compareAndSwap ( æ—§å€¼, ç»“æœ )) { 
   // æˆåŠŸï¼Œé€€å‡ºå¾ªç¯
 } 
}
```

è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºç«äº‰ä¸æ¿€çƒˆã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚

- å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€
- ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“

CAS åº•å±‚ä¾èµ–äºä¸€ä¸ª Unsafe ç±»æ¥ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚çš„ CAS æŒ‡ä»¤ï¼Œä¸‹é¢æ˜¯ç›´æ¥ä½¿ç”¨ Unsafe å¯¹è±¡è¿›è¡Œçº¿ç¨‹å®‰å…¨ä¿æŠ¤çš„ä¸€ä¸ªä¾‹å­

```java
import sun.misc.Unsafe; 
import java.lang.reflect.Field; 
public class TestCAS {
   public static void main(String[] args) throws InterruptedException { 
       DataContainer dc = new DataContainer();
       int count = 5;      
       Thread t1 = new Thread(() -> {
           for (int i = 0; i < count; i++) { 
               dc.increase();
           }
       });
       t1.start(); 
       t1.join();
       System.out.println(dc.getData()); 
   }
}
class DataContainer {
   private volatile int data;
   static final Unsafe unsafe;
   static final long DATA_OFFSET;
   static { 
       try {
           // Unsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—
           Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe"); 
           theUnsafe.setAccessible(true);
           unsafe = (Unsafe) theUnsafe.get(null);
       } catch (NoSuchFieldException | IllegalAccessException e) { 
           throw new Error(e);
       }
       try {
           // data å±æ€§åœ¨    DataContainer å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œç”¨äº    Unsafe ç›´æ¥è®¿é—®è¯¥å±æ€§ 
           DATA_OFFSET =
unsafe.objectFieldOffset(DataContainer.class.getDeclaredField("data")); 
       } catch (NoSuchFieldException e) {
           throw new Error(e); 
       }
   }
   public void increase() { 
       int oldValue;
       while(true) {
           // è·å–å…±äº«å˜é‡æ—§å€¼ï¼Œå¯ä»¥åœ¨è¿™ä¸€è¡ŒåŠ å…¥æ–­ç‚¹ï¼Œä¿®æ”¹    data è°ƒè¯•æ¥åŠ æ·±ç†è§£ 
           oldValue = data;
           // cas å°è¯•ä¿®æ”¹    data ä¸º    æ—§å€¼    + 1ï¼Œå¦‚æœæœŸé—´æ—§å€¼è¢«åˆ«çš„çº¿ç¨‹æ”¹äº†ï¼Œè¿”å›    false
           if (unsafe.compareAndSwapInt(this, DATA_OFFSET, oldValue, oldValue +
1)) {
               return; 
           }
       } 
  }
   public void decrease() { 
       int oldValue;
       while(true) {
           oldValue = data;
           if (unsafe.compareAndSwapInt(this, DATA_OFFSET, oldValue, oldValue -
1)) {
               return; 
           }
       } 
    }
    public int getData() { 
       return data;
    }
}
```



### 4.2 ä¹è§‚é”ä¸æ‚²è§‚é”

- CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šæœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œ æˆ‘åƒäºç‚¹å†é‡è¯•å‘—ã€‚
- synchronized æ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šæœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é”ä½ ä»¬éƒ½åˆ«æƒ³æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚



### 4.3 åŸå­æ“ä½œç±»

jucï¼ˆjava.util.concurrentï¼‰ä¸­æä¾›äº†åŸå­æ“ä½œç±»ï¼Œå¯ä»¥æä¾›çº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šAtomicIntegerã€AtomicBooleanç­‰ï¼Œå®ƒä»¬åº•å±‚å°±æ˜¯é‡‡ç”¨ CAS æŠ€æœ¯ + volatile æ¥å®ç°çš„ã€‚

å¯ä»¥ä½¿ç”¨ AtomicInteger æ”¹å†™ä¹‹å‰çš„ä¾‹å­ï¼š

```java
// åˆ›å»ºåŸå­æ•´æ•°å¯¹è±¡
private static AtomicInteger i = new AtomicInteger(0);
public static void main(String[] args) throws InterruptedException { 
   Thread t1 = new Thread(() -> {
       for (int j = 0; j < 5000; j++) {
           i.getAndIncrement();  // è·å–å¹¶ä¸”è‡ªå¢ i++
//                i.incrementAndGet();  // è‡ªå¢å¹¶ä¸”è·å– ++i
       } 
   });
   Thread t2 = new Thread(() -> {
       for (int j = 0; j < 5000; j++) {
           i.getAndDecrement(); // è·å–å¹¶ä¸”è‡ªå‡         i-- 
     }
   });
   t1.start(); 
   t2.start(); 
   t1.join(); 
   t2.join();
   System.out.println(i);
}
```





## 5. synchronized ä¼˜åŒ–

Java HotSpot è™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯¹è±¡å¤´ï¼ˆåŒ…æ‹¬ class æŒ‡é’ˆå’Œ Mark Wordï¼‰ã€‚Mark Word å¹³æ—¶å­˜å‚¨è¿™ä¸ªå¯¹è±¡çš„ `å“ˆå¸Œç ` ã€ `åˆ†ä»£å¹´é¾„` ï¼Œå½“åŠ é”æ—¶ï¼Œè¿™äº›ä¿¡æ¯å°±æ ¹æ®æƒ…å†µè¢«æ›¿æ¢ä¸º `æ ‡è®°ä½` ã€ `çº¿ç¨‹é”è®°å½•æŒ‡é’ˆ` ã€ `é‡é‡çº§é”æŒ‡é’ˆ` ã€ `çº¿ç¨‹ID` ç­‰å†…å®¹



### 5.1 è½»é‡çº§é”

å¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½» é‡çº§é”æ¥ä¼˜åŒ–ã€‚è¿™å°±å¥½æ¯”ï¼š

å­¦ç”Ÿï¼ˆçº¿ç¨‹ Aï¼‰ç”¨è¯¾æœ¬å åº§ï¼Œä¸Šäº†åŠèŠ‚è¯¾ï¼Œå‡ºé—¨äº†ï¼ˆCPUæ—¶é—´åˆ°ï¼‰ï¼Œå›æ¥ä¸€çœ‹ï¼Œå‘ç°è¯¾æœ¬æ²¡å˜ï¼Œè¯´æ˜æ²¡æœ‰ç«äº‰ï¼Œç»§ç»­ä¸Šä»–çš„è¯¾ã€‚

å¦‚æœè¿™æœŸé—´æœ‰å…¶å®ƒå­¦ç”Ÿï¼ˆçº¿ç¨‹ Bï¼‰æ¥äº†ï¼Œä¼šå‘ŠçŸ¥ï¼ˆçº¿ç¨‹Aï¼‰æœ‰å¹¶å‘è®¿é—®ï¼Œçº¿ç¨‹ A éšå³å‡çº§ä¸ºé‡é‡çº§é”ï¼Œ è¿›å…¥é‡é‡çº§é”çš„æµç¨‹ã€‚

è€Œé‡é‡çº§é”å°±ä¸æ˜¯é‚£ä¹ˆç”¨è¯¾æœ¬å åº§é‚£ä¹ˆç®€å•äº†ï¼Œå¯ä»¥æƒ³è±¡çº¿ç¨‹ A èµ°ä¹‹å‰ï¼ŒæŠŠåº§ä½ç”¨ä¸€ä¸ªé“æ …æ å›´èµ·æ¥å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”

```java
static Object obj = new Object(); 
public static void method1() { 
   synchronized( obj ) {
       // åŒæ­¥å— A 
       method2(); 
   }
}
public static void method2() { 
   synchronized( obj ) {
       // åŒæ­¥å— B 
   }
}
```

æ¯ä¸ªçº¿ç¨‹éƒ½çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word

| çº¿ç¨‹ 1                                      | å¯¹è±¡ Mark Word               | çº¿ç¨‹ 2                                      |
| ------------------------------------------- | :--------------------------- | ------------------------------------------- |
| è®¿é—®åŒæ­¥å— Aï¼ŒæŠŠ Mark å¤åˆ¶åˆ°çº¿ç¨‹ 1 çš„é”è®°å½• | 01ï¼ˆæ— é”ï¼‰                   | -                                           |
| CAS ä¿®æ”¹ Mark ä¸ºçº¿ç¨‹ 1 é”è®°å½•åœ°å€           | 01ï¼ˆæ— é”ï¼‰                   | -                                           |
| æˆåŠŸï¼ˆåŠ é”ï¼‰                                | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| æ‰§è¡ŒåŒæ­¥å— A                                | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| è®¿é—®åŒæ­¥å— Bï¼ŒæŠŠ Mark å¤åˆ¶åˆ°çº¿ç¨‹ 1 çš„é”è®°å½• | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| CAS ä¿®æ”¹ Mark ä¸ºçº¿ç¨‹ 1 é”è®°å½•åœ°å€           | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| å¤±è´¥ï¼ˆå‘ç°æ˜¯è‡ªå·±çš„é”ï¼‰                      | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| é”é‡å…¥                                      | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| æ‰§è¡ŒåŒæ­¥å— B                                | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| åŒæ­¥å— B æ‰§è¡Œå®Œæ¯•                           | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| åŒæ­¥å— A æ‰§è¡Œå®Œæ¯•                           | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1é”è®°å½•åœ°å€ | -                                           |
| æˆåŠŸï¼ˆè§£é”ï¼‰                                | 01ï¼ˆæ— é”ï¼‰                   | -                                           |
| -                                           | 01ï¼ˆæ— é”ï¼‰                   | è®¿é—®åŒæ­¥å— Aï¼ŒæŠŠ Mark å¤åˆ¶åˆ°çº¿ç¨‹ 2 çš„é”è®°å½• |
| -                                           | 01ï¼ˆæ— é”ï¼‰                   | CAS ä¿®æ”¹ Mark ä¸ºçº¿ç¨‹ 2 é”è®°å½•åœ°å€           |
| -                                           | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 2é”è®°å½•åœ°å€ | æˆåŠŸï¼ˆåŠ é”ï¼‰                                |
| -                                           | ...                          | ...                                         |



### 5.2 é”è†¨èƒ€

å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚

```java
static Object obj = new Object(); 
public static void method1() { 
   synchronized( obj ) {
       // åŒæ­¥å— 
   }
}
```

| çº¿ç¨‹ 1                                   | å¯¹è±¡ Mark                     | çº¿ç¨‹ 2                            |
| ---------------------------------------- | ----------------------------- | --------------------------------- |
| è®¿é—®åŒæ­¥å—ï¼ŒæŠŠ Mark å¤åˆ¶åˆ°çº¿ç¨‹1 çš„é”è®°å½• | 01ï¼ˆæ— é”ï¼‰                    | -                                 |
| CAS ä¿®æ”¹ Mark ä¸ºçº¿ç¨‹ 1 é”è®°å½•åœ°å€        | 01ï¼ˆæ— é”ï¼‰                    | -                                 |
| æˆåŠŸï¼ˆåŠ é”ï¼‰                             | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1 é”è®°å½•åœ°å€ | -                                 |
| æ‰§è¡ŒåŒæ­¥å—                               | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1 é”è®°å½•åœ°å€ | -                                 |
| æ‰§è¡ŒåŒæ­¥å—                               | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1 é”è®°å½•åœ°å€ | è®¿é—®åŒæ­¥å—ï¼ŒæŠŠ Mark å¤åˆ¶åˆ°çº¿ç¨‹ 2  |
| æ‰§è¡ŒåŒæ­¥å—                               | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1 é”è®°å½•åœ°å€ | CAS ä¿®æ”¹ Mark ä¸ºçº¿ç¨‹ 2 é”è®°å½•åœ°å€ |
| æ‰§è¡ŒåŒæ­¥å—                               | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1 é”è®°å½•åœ°å€ | å¤±è´¥ï¼ˆå‘ç°åˆ«äººå·²ç»å äº†é”ï¼‰        |
| æ‰§è¡ŒåŒæ­¥å—                               | 00ï¼ˆè½»é‡é”ï¼‰çº¿ç¨‹ 1 é”è®°å½•åœ°å€ | CAS ä¿®æ”¹ Mark ä¸ºé‡é‡é”            |
| æ‰§è¡ŒåŒæ­¥å—                               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ        | é˜»å¡ä¸­                            |
| æ‰§è¡Œå®Œæ¯•                                 | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ        | é˜»å¡ä¸­                            |
| å¤±è´¥ï¼ˆè§£é”ï¼‰                             | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ        | é˜»å¡ä¸­                            |
| é‡Šæ”¾é‡é‡é”ï¼Œå”¤èµ·é˜»å¡çº¿ç¨‹ç«äº‰             | 01ï¼ˆæ— é”ï¼‰                    | é˜»å¡ä¸­                            |
| -                                        | 10ï¼ˆé‡é‡é”ï¼‰                  | ç«äº‰é‡é‡é”                        |
| -                                        | 10ï¼ˆé‡é‡é”ï¼‰                  | æˆåŠŸï¼ˆåŠ é”ï¼‰                      |
| -                                        | ...                           | ...                               |



### 5.3 é‡é‡é”

é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€ å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚

åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚

- è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚
- å¥½æ¯”ç­‰çº¢ç¯æ—¶æ±½è½¦æ˜¯ä¸æ˜¯ç†„ç«ï¼Œä¸ç†„ç«ç›¸å½“äºè‡ªæ—‹ï¼ˆç­‰å¾…æ—¶é—´çŸ­äº†åˆ’ç®—ï¼‰ï¼Œç†„ç«äº†ç›¸å½“äºé˜»å¡ï¼ˆç­‰ å¾…æ—¶é—´é•¿äº†åˆ’ç®—ï¼‰
- Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½

è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ

| çº¿ç¨‹ 1 (CPU1ä¸Š)          | å¯¹è±¡ Mark              | çº¿ç¨‹ 2 (CPU2ä¸Š)          |
| ------------------------ | ---------------------- | ------------------------ |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰           | -                        |
| è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æˆåŠŸï¼ˆåŠ é”ï¼‰             | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡Œå®Œæ¯•                 | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æˆåŠŸï¼ˆè§£é”ï¼‰             | 01ï¼ˆæ— é”ï¼‰             | è‡ªæ—‹é‡è¯•                 |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | æˆåŠŸï¼ˆåŠ é”ï¼‰             |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | æ‰§è¡ŒåŒæ­¥å—               |
| -                        | ...                    | ...                      |

è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µ

| çº¿ç¨‹ 1 (CPU1ä¸Š)          | å¯¹è±¡ Mark              | çº¿ç¨‹ 2 (CPU2ä¸Š)          |
| ------------------------ | ---------------------- | ------------------------ |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰           | -                        |
| è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æˆåŠŸï¼ˆåŠ é”ï¼‰             | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | é˜»å¡                     |
| -                        | ...                    | ...                      |



### 5.4 åå‘é”

è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ ID è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CAS.

- æ’¤é”€åå‘éœ€è¦å°†æŒé”çº¿ç¨‹å‡çº§ä¸ºè½»é‡çº§é”ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€æœ‰çº¿ç¨‹éœ€è¦æš‚åœï¼ˆSTWï¼‰ 
- è®¿é—®å¯¹è±¡çš„ hashCode ä¹Ÿä¼šæ’¤é”€åå‘é”
- å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œ é‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID
- æ’¤é”€åå‘å’Œé‡åå‘éƒ½æ˜¯æ‰¹é‡è¿›è¡Œçš„ï¼Œä»¥ç±»ä¸ºå•ä½
- å¦‚æœæ’¤é”€åå‘åˆ°è¾¾æŸä¸ªé˜ˆå€¼ï¼Œæ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„
- å¯ä»¥ä¸»åŠ¨ä½¿ç”¨ -XX:-UseBiasedLocking ç¦ç”¨åå‘é”

[å¯ä»¥å‚è€ƒè¿™ç¯‡è®ºæ–‡ï¼šhttps://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf](https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf)

å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”

```java
static Object obj = new Object(); 
public static void method1() { 
   synchronized( obj ) {
       // åŒæ­¥å— A 
       method2(); 
   }
}
public static void method2() { 
   synchronized( obj ) {
       // åŒæ­¥å—    B 
   }
}
```

| çº¿ç¨‹ 1                                      | å¯¹è±¡ Mark                      |
| ------------------------------------------- | ------------------------------ |
| è®¿é—®åŒæ­¥å— Aï¼Œæ£€æŸ¥ Mark ä¸­æ˜¯å¦æœ‰çº¿ç¨‹ ID     | 101ï¼ˆæ— é”å¯åå‘ï¼‰              |
| å°è¯•åŠ åå‘é”                                | 101ï¼ˆæ— é”å¯åå‘ï¼‰å¯¹è±¡ hashCode |
| æˆåŠŸ                                        | 101ï¼ˆæ— é”å¯åå‘ï¼‰çº¿ç¨‹ID        |
| æ‰§è¡ŒåŒæ­¥å— A                                | 101ï¼ˆæ— é”å¯åå‘ï¼‰çº¿ç¨‹ID        |
| è®¿é—®åŒæ­¥å— Bï¼Œæ£€æŸ¥ Mark ä¸­æ˜¯å¦æœ‰çº¿ç¨‹ ID     | 101ï¼ˆæ— é”å¯åå‘ï¼‰çº¿ç¨‹ID        |
| æ˜¯è‡ªå·±çš„çº¿ç¨‹ IDï¼Œé”æ˜¯è‡ªå·±çš„ï¼Œæ— éœ€åšæ›´å¤šæ“ä½œ | 101ï¼ˆæ— é”å¯åå‘ï¼‰çº¿ç¨‹ID        |
| æ‰§è¡ŒåŒæ­¥å— B                                | 101ï¼ˆæ— é”å¯åå‘ï¼‰çº¿ç¨‹ID        |
| æ‰§è¡Œå®Œæ¯•                                    | 101ï¼ˆæ— é”å¯åå‘ï¼‰å¯¹è±¡ hashCode |



### 5.5 å…¶å®ƒä¼˜åŒ–

#### 1. å‡å°‘ä¸Šé”æ—¶é—´

åŒæ­¥ä»£ç å—ä¸­å°½é‡çŸ­

#### 2. å‡å°‘é”çš„ç²’åº¦

å°†ä¸€ä¸ªé”æ‹†åˆ†ä¸ºå¤šä¸ªé”æé«˜å¹¶å‘åº¦ï¼Œä¾‹å¦‚ï¼š

- ConcurrentHashMap
- LongAdder åˆ†ä¸º base å’Œ cells ä¸¤éƒ¨åˆ†ã€‚æ²¡æœ‰å¹¶å‘äº‰ç”¨çš„æ—¶å€™æˆ–è€…æ˜¯ cells æ•°ç»„æ­£åœ¨åˆå§‹åŒ–çš„æ—¶ å€™ï¼Œä¼šä½¿ç”¨ CAS æ¥ç´¯åŠ å€¼åˆ° baseï¼Œæœ‰å¹¶å‘äº‰ç”¨ï¼Œä¼šåˆå§‹åŒ– cells æ•°ç»„ï¼Œæ•°ç»„æœ‰å¤šå°‘ä¸ª cellï¼Œå°±å…è®¸æœ‰å¤šå°‘çº¿ç¨‹å¹¶è¡Œä¿®æ”¹ï¼Œæœ€åå°†æ•°ç»„ä¸­æ¯ä¸ª cell ç´¯åŠ ï¼Œå†åŠ ä¸Š base å°±æ˜¯æœ€ç»ˆçš„å€¼
- LinkedBlockingQueue å…¥é˜Ÿå’Œå‡ºé˜Ÿä½¿ç”¨ä¸åŒçš„é”ï¼Œç›¸å¯¹äºLinkedBlockingArrayåªæœ‰ä¸€ä¸ªé”æ•ˆç‡è¦é«˜

#### 3. é”ç²—åŒ–

å¤šæ¬¡å¾ªç¯è¿›å…¥åŒæ­¥å—ä¸å¦‚åŒæ­¥å—å†…å¤šæ¬¡å¾ªç¯

å¦å¤– JVM å¯èƒ½ä¼šåšå¦‚ä¸‹ä¼˜åŒ–ï¼ŒæŠŠå¤šæ¬¡ append çš„åŠ é”æ“ä½œç²—åŒ–ä¸ºä¸€æ¬¡ï¼ˆå› ä¸ºéƒ½æ˜¯å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œ æ²¡å¿…è¦é‡å…¥å¤šæ¬¡ï¼‰

```java
new StringBuffer().append("a").append("b").append("c");
```

#### 4. é”æ¶ˆé™¤

JVM ä¼šè¿›è¡Œä»£ç çš„é€ƒé€¸åˆ†æï¼Œä¾‹å¦‚æŸä¸ªåŠ é”å¯¹è±¡æ˜¯æ–¹æ³•å†…å±€éƒ¨å˜é‡ï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰€è®¿é—®åˆ°ï¼Œè¿™æ—¶å€™å°±ä¼šè¢«å³æ—¶ç¼–è¯‘å™¨å¿½ç•¥æ‰æ‰€æœ‰åŒæ­¥æ“ä½œã€‚

#### 5. è¯»å†™åˆ†ç¦»

CopyOnWriteArrayList 

ConyOnWriteSet





> å‚è€ƒï¼š
>
> - https://wiki.openjdk.java.net/display/HotSpot/Synchronization 
> - http://luojinping.com/2015/07/09/javaé”ä¼˜åŒ–/ 
> - https://www.infoq.cn/article/java-se-16-synchronizedhttps://www.jianshu.com/p/9932047a89be 
> - https://www.cnblogs.com/sheeva/p/6366782.html 
> - https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock



















